# GraphQL Resolver Batching & Caching Demo

This project demonstrates using dataloaders (`dataloadgen`) with `gqlgen` to implement batching and basic request-level caching for GraphQL resolvers in Go.

## Prerequisites

*   Go (version 1.23 or later recommended)
*   Make

## Setup & Running

1.  **Install Dependencies:**
    ```bash
    go mod tidy
    ```

2.  **Generate Code:**
    This step uses `gqlgen` to generate Go code based on the GraphQL schema.
    ```bash
    make gen
    ```

3.  **Build the Server:**
    ```bash
    make build
    ```
    This creates an executable at `./bin/server`.

4.  **Run the Server:**
    ```bash
    ./bin/server
    ```

By default, the server runs on port `8080`.

*   **GraphQL Playground:** [http://localhost:8080/](http://localhost:8080/)
*   **GraphQL Endpoint:** [http://localhost:8080/query](http://localhost:8080/query)

## Makefile Targets

*   `make gen`: Regenerates GraphQL code using `gqlgen` based on the schema in `graph/schema/`. Generated files are placed in the `gen/` directory.
*   `make build`: Compiles the Go project and creates the executable at `./bin/server`.
*   `make clean`: Removes the generated code directory (`gen/`) and the build artifact (`./bin/server`).

## Project Structure

*   `cmd/server/main.go`: Main application entry point.
*   `internal/schema/`: Contains the GraphQL schema files (`.graphql`).
*   `internal/loaders/`: Contains the dataloader implementation (`dataloaders.go`).
*   `internal/resolvers/`: Contains custom resolver implementations.
*   `internal/resolver_root.go`: Integrates custom resolvers.
*   `internal/gen/`: Contains code generated by `gqlgen` (specified in `gqlgen.yml`).
    *   `internal/gen/graph/generated.go`: Core generated server code.
    *   `internal/gen/graph/model/models_gen.go`: Generated Go model types.
    *   `internal/gen/graph/*.resolvers.go`: Generated resolver stubs/implementations.
    *   `internal/gen/graph/resolver.go`: Root resolver struct (modified).
*   `gqlgen.yml`: Configuration file for `gqlgen`.
*   `Makefile`: For automating build, generation, and cleaning tasks.
*   `go.mod`, `go.sum`: Go module files.

## Key Features

- **DataLoader Pattern** - Consolidates multiple resolver calls into a single batch request, avoiding the N+1 query problem
- **Request-Scoped Caching** - The DataLoader caches results within a single request/subscription cycle
- **Attempt Tracking** - Tracks which symbols have been resolved, enabling clients to control whether subsequent accesses should return cached values or nil

## Resolver Behavior

The `NextExDividendDate` field resolver has the following behavior controlled by the `singleFlight` argument:

- When `singleFlight` is `true` (default):
  - First access within a request: Makes the upstream API call (or joins an existing batch) and caches the result.
  - Subsequent accesses within the same request: Returns the cached value without hitting the API again (standard dataloader behavior).

- When `singleFlight` is `false`:
  - First access within a request: Makes the upstream API call, caches the result, and marks the symbol as attempted for this request.
  - Subsequent accesses within the same request: Returns `nil` immediately without hitting the API or cache.

This `singleFlight: false` behavior is useful in scenarios like subscriptions where you want to fetch the data only once per event, even if the resolver field is accessed multiple times during the processing of that single event.

## Example Queries

### Basic Query

```graphql
query GetSymbols {
  symbols(names: ["AAPL", "MSFT", "GOOG"]) {
    Name
    NextExDividendDate
  }
}
```

### Query with singleFlight Parameter

```graphql
query GetSymbols {
  symbols(names: ["AAPL", "MSFT", "GOOG"]) {
    Name
    NextExDividendDate(singleFlight: false)
  }
}
```

### Subscription

```graphql
subscription WatchSymbols {
  symbolUpdates(names: ["AAPL", "MSFT", "GOOG"]) {
    Name
    NextExDividendDate(singleFlight: false)
  }
}
```

## Implementation Details

- The DataLoader is defined in `graph/loaders/dataloaders.go`
- The HTTP middleware to inject the loader into each request is in the same file
- The resolver logic is in `graph/schema.resolvers.go`
- The server configuration is in `cmd/server/main.go`

## License

MIT 